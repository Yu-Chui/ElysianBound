{%- doc -%}
  Renders mega menu list markup and optional featured content.

  @param {object} parent_link - The linklist to render.
  @param {string} id - Unique ID to assign to the `<ul>` element.
  @param {string} [menu_content_type] - Type of content: 'featured_products', 'featured_collections', 'collection_images', or 'text'.
  @param {number} [content_aspect_ratio] - Aspect ratio for content images.
  @param {number} [image_border_radius] - Border radius for content images.
  @param {object} [section] - The section object.

  @example
  {% render 'mega-menu-list', parent_link: link, id: 'MegaMenuList-1', menu_content_type: 'featured_products' %}
{%- enddoc -%}

{% liquid
  comment
    核心修改：关闭多列逻辑，强制单列垂直布局
  endcomment
  assign open_column_span = false
  assign column_count = 1 
  assign links_before_wrap = 10
  assign max_menu_columns = 1 
  assign max_menu_columns_tablet = 1 

  assign eager_loading = false
  if section.index == blank
    assign eager_loading = true
  endif

  if menu_content_type == 'collection_images'
    assign collection_links = parent_link.links | where: 'type', 'collection_link'
    assign catalog_links = parent_link.links | where: 'type', 'catalog_link'
    assign collection_list_links = parent_link.links | where: 'type', 'collections_link'
    if collection_links.size == 0 and catalog_links.size == 0 and collection_list_links.size == 0
      assign menu_content_type = 'text'
    endif
  endif

  if menu_content_type == 'featured_collections'
    if parent_link.type == 'collection_link'
      assign collection_handles = parent_link.object.handle | append: ','
    elsif parent_link.type == 'catalog_link' or parent_link.type == 'collections_link'
      assign collection_handles = 'all' | append: ','
    endif
    assign collection_links = parent_link.links | where: 'type', 'collection_link'
    for collection_link in collection_links
      assign collection_handles = collection_handles | append: collection_link.object.handle | append: ','
    endfor
  endif

  if menu_content_type == 'featured_products'
    if parent_link.type == 'collection_link'
      assign collection_object = parent_link.object
    elsif parent_link.type == 'catalog_link' or parent_link.type == 'collections_link'
      assign collection_object = collections.all
    else
      assign menu_content_type = 'text'
    endif
  endif
%}
<ul
  data-menu-list-id="{{ id }}"
  class="mega-menu__list list-unstyled"
  style="--menu-image-border-radius: {{ image_border_radius }}px; --menu-columns-desktop: 1; --menu-columns-tablet: 1;" 
>
  {% for link in parent_link.links %}
    {% liquid
      # 核心修改：强制单列，关闭多列跨度逻辑
      if forloop.first or open_column_span == false
        assign open_column_span = true
        assign column_span = 1 
        assign column_count = 1 
        assign should_break_columns = false 
        assign span_class = 'mega-menu__column--span-1' 
        echo '<li class="mega-menu__column ' | append: span_class | append: '">'
      endif
    %}
    <div>
      <a
        href="{{ link.url }}"
        class="mega-menu__link {% if link.links != blank %}mega-menu__link--parent{% endif %}"
      >
        {% if menu_content_type == 'collection_images' %}
          {%- capture collection_image_sizes -%}
            {%- assign columns_per_item = 1 -%} 
            {%- render 'util-mega-menu-img-sizes-attr',
              menu_content_type: 'collection_images',
              settings: settings,
              grid_columns: 1,
              grid_columns_tablet: 1,
              grid_columns_collection_images: 1,
              parent_links_size: 1,
              columns_per_item: 1
            -%}
          {%- endcapture -%}

          {% render 'link-featured-image', link: link, class: 'mega-menu__link-image', sizes: collection_image_sizes %}
        {% endif %}
        <span
          class="mega-menu__link-title wrap-text"
        >
          {{- link.title -}}
        </span>
      </a>
      {% if link.links != blank %}
        <ul
          class="list-unstyled"
          style="column-count: 1; margin: 0; padding: 0;" # 强制单列，移除多余边距
        >
          {% for childLink in link.links %}
            <li style="break-after: none; margin: 0; padding: 0;"> # 关闭列分割，移除多余边距
              <a
                href="{{ childLink.url }}"
                class="mega-menu__link"
              >
                <span class="mega-menu__link-title wrap-text">{{- childLink.title -}}</span>
              </a>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>

    {% liquid
      # 强制关闭列跨度，确保单列闭合
      if forloop.last or open_column_span == false
        assign open_column_span = false
        echo '</li>'
      endif
    %}
  {% endfor %}
</ul>

{% liquid
  # 核心修改：关闭特色内容多列逻辑，强制单列
  assign min_products = 1
  assign max_products = 1
  assign min_products_tablet = 1
  assign max_products_tablet = 1
  assign min_collections = 1

  if menu_content_type == 'featured_products'
    assign max_product_columns = 1
    assign max_featured_products = 1
    assign max_menu_columns = 1
    assign max_product_columns_tablet = 1
    assign max_featured_products_tablet = 1
    assign max_menu_columns_tablet = 1
  endif

  if menu_content_type == 'featured_collections'
    assign max_collection_columns = 1
    assign max_featured_collections = 1
    assign max_menu_columns = 1
    assign max_collection_columns_tablet = 1
    assign max_featured_collections_tablet = 1
    assign max_menu_columns_tablet = 1
  endif
%}

{% style %}
  [data-menu-grid-id="{{ id }}"] {
    --menu-columns-desktop: 1 !important; # 强制单列
    --menu-columns-tablet: 1 !important; # 强制单列
  }

  [data-menu-list-id="{{ id }}"] {
    --menu-columns-desktop: 1 !important; # 强制单列
    --menu-columns-tablet: 1 !important; # 强制单列
    display: block !important; # 强制块级布局
    gap: 0 !important; # 移除间距
    margin: 0 !important; # 移除边距
    padding: 0 !important; # 移除内边距
  }

  /* 彻底移除子菜单内部的多余空白 */
  .mega-menu__column {
    margin: 0 !important;
    padding: 0 !important;
  }

  .mega-menu__link {
    margin: 0 !important;
    padding: 0 !important; # 无padding
  }
{% endstyle %}

{% case menu_content_type %}
  {% when 'featured_products' %}
    {%- capture image_sizes -%}
      {%- render 'util-mega-menu-img-sizes-attr',
        menu_content_type: 'featured_products',
        settings: settings,
        grid_columns: 1,
        grid_columns_tablet: 1
      -%}
    {%- endcapture -%}

    <span
      class="mega-menu__content"
      style="--menu-content-columns-desktop: 1; --menu-content-columns-tablet: 1; --resource-card-corner-radius: {{ image_border_radius }}px;"
    >
      <ul
        class="mega-menu__content-list mega-menu__content-list--products list-unstyled"
        style="display: block; margin: 0; padding: 0;"
      >
        {% if eager_loading %}
          {% paginate collection_object.products by 1 %}
            {% for item in collection_object.products %}
              <li class="mega-menu__content-list-item" style="margin: 0; padding: 0;">
                {% render 'resource-card',
                  resource: item,
                  resource_type: 'product',
                  image_hover: true,
                  image_aspect_ratio: content_aspect_ratio,
                  image_sizes: image_sizes
                %}
              </li>
            {% endfor %}
          {% endpaginate %}
        {% endif %}
      </ul>
    </span>
  {% when 'featured_collections' %}
    {% assign collection_handles = collection_handles | split: ',' | uniq %}
    {%- capture image_sizes -%}
      {%- render 'util-mega-menu-img-sizes-attr',
        menu_content_type: 'featured_collections',
        settings: settings
      -%}
    {%- endcapture -%}

    {% if collection_handles.size == 1 %}
      {% assign max_featured_collections = 1 %}
    {% endif %}

    <span
      class="mega-menu__content"
      style="--menu-content-columns-desktop: 1; --menu-content-columns-tablet: 1; --resource-card-corner-radius: {{ image_border_radius }}px;"
    >
      <ul
        class="mega-menu__content-list mega-menu__content-list--collections list-unstyled"
        style="display: block; margin: 0; padding: 0;"
      >
        {% for handle in collection_handles limit: 1 %}
          {% if handle == 'all' %}
            {% assign collection_object = collections.all %}
          {% else %}
            {% assign collection_object = collections[handle] %}
          {% endif %}
          <li class="mega-menu__content-list-item" style="margin: 0; padding: 0;">
            {% render 'resource-card',
              resource: collection_object,
              resource_type: 'collection',
              style: 'overlay',
              image_aspect_ratio: content_aspect_ratio,
              image_sizes: image_sizes
            %}
          </li>
        {% endfor %}
      </ul>
    </span>
{% endcase %}